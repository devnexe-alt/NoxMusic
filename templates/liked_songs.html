{% extends "base.html" %}

{% block content %}
<header class="hero">
  <div id="hero-inner">
    <div style="display:flex;gap:24px;align-items:flex-end">
      <div style="width:232px;height:232px;background:linear-gradient(135deg,#450af5,#c4efd9);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:80px;box-shadow:0 8px 24px rgba(0,0,0,0.5)">üíö</div>
      <div>
        <div style="font-size:12px;font-weight:700;text-transform:uppercase;margin-bottom:8px">Playlist</div>
        <h1 style="font-size:96px;font-weight:900;margin:0 0 24px 0">Liked Songs</h1>
        <div style="display:flex;gap:8px;align-items:center;color:var(--muted)">
          <span style="font-weight:700;color:#fff">{{ current_user.username if current_user else 'User' }}</span>
          <span>‚Ä¢</span>
          <span>{{ liked_count }} songs</span>
        </div>
      </div>
    </div>
  </div>
</header>

<section class="content">
  <div class="tracks">
    <div class="tracks-head">
      <div>#</div>
      <div>TITLE</div>
      <div>ALBUM</div>
      <div></div>
      <div></div>
      <div>‚è±</div>
    </div>
    
    {% if liked_count > 0 %}
      {% for t in liked_tracks %}
      <div class="track-row" data-id="{{ t.id }}">
        <div class="track-index">{{ loop.index }}</div>
        <div style="display:flex;gap:10px;align-items:center">
          <div class="track-cover" style="background:{{ t.gradient }};cursor:pointer" onclick="playTrack({{ t.id }})">{{ t.cover }}</div>
          <div>
            <div class="track-title" style="cursor:pointer" onclick="playTrack({{ t.id }})">{{ t.title }}</div>
            <div class="track-artist">{{ t.artist }}</div>
          </div>
        </div>
        <div class="meta">{{ t.album }}</div>
        <div class="track-actions">
          <button class="like-btn" onclick="toggleLike({{ t.id }})" style="color: #1db954;">üíö</button>
          <button class="queue-add" onclick="addToQueue({{ t.id }})">+</button>
          <button class="add-to-pl" onclick="showAddToPlaylistMenu({{ t.id }})">‚ãØ</button>
        </div>
        <div style="text-align:right">
          {% if t.duration %}
            {{ (t.duration // 60) }}:{% if (t.duration % 60) < 10 %}0{% endif %}{{ t.duration % 60 }}
          {% else %}
            0:00
          {% endif %}
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
        <div style="font-size: 48px; margin-bottom: 16px;">üíö</div>
        <h3>No liked songs yet</h3>
        <p>Like some songs to see them here</p>
        <a href="{{ url_for('main.index') }}" style="display: inline-block; margin-top: 16px; padding: 12px 24px; background: var(--accent); border-radius: 20px; color: white; text-decoration: none;">
          Browse Music
        </a>
      </div>
    {% endif %}
  </div>
</section>

<script>
function playTrack(trackId) {
  fetch(`/api/tracks/${trackId}/play`, { method: 'POST' })
    .then(() => {
      // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–ª–µ–µ—Ä–∞
      window.location.href = `/track/${trackId}`;
    });
}

async function toggleLike(trackId) {
  const res = await fetch(`/api/tracks/${trackId}/like`, { method: 'POST' });
  if (res.ok) {
    const data = await res.json();
    if (!data.liked) {
      // –ï—Å–ª–∏ —É–±—Ä–∞–ª–∏ –ª–∞–π–∫, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
      location.reload();
    }
  }
}

function addToQueue(trackId) {
  fetch(`/api/queue/add/${trackId}`, { method: 'POST' })
    .then(() => {
      alert('Added to queue');
    });
}

function showAddToPlaylistMenu(trackId) {
  // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  fetch('/api/playlists')
    .then(res => res.json())
    .then(playlists => {
      if (playlists.length === 0) {
        alert('No playlists yet. Create one first!');
        return;
      }
      
      const menu = document.createElement('div');
      menu.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#282828;border-radius:8px;padding:16px;box-shadow:0 16px 48px rgba(0,0,0,0.5);z-index:1000;min-width:300px;max-height:400px;overflow-y:auto';
      
      menu.innerHTML = `
        <div style="font-weight:700;margin-bottom:12px;padding:8px">Add to playlist</div>
        ${playlists.map(p => `
          <div class="playlist-menu-item" data-id="${p.id}" style="padding:12px 8px;border-radius:4px;cursor:pointer;transition:background 0.2s;display:flex;align-items:center;gap:12px">
            <div style="width:40px;height:40px;border-radius:4px;background:${p.gradient};display:flex;align-items:center;justify-content:center">${p.cover}</div>
            <div>
              <div style="font-weight:500">${p.name}</div>
              <div style="font-size:12px;color:var(--muted)">${p.trackCount} songs</div>
            </div>
          </div>
        `).join('')}
        <button onclick="this.parentElement.remove()" style="margin-top:12px;width:100%;padding:12px;background:rgba(255,255,255,0.1);border:none;border-radius:4px;color:#fff;cursor:pointer;font-weight:600">Cancel</button>
      `;
      
      document.body.appendChild(menu);
      
      menu.querySelectorAll('.playlist-menu-item').forEach(item => {
        item.onmouseenter = () => item.style.background = 'rgba(255,255,255,0.1)';
        item.onmouseleave = () => item.style.background = 'transparent';
        item.onclick = async () => {
          const plId = item.getAttribute('data-id');
          const res = await fetch(`/api/playlists/${plId}/tracks`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ track_id: trackId })
          });
          if (res.ok) {
            alert('Added to playlist!');
            menu.remove();
          } else {
            alert('Error adding to playlist');
          }
        };
      });
    });
}
</script>
{% endblock %}